# Redis Cluster for integration testing
#
# Usage:
#   docker compose -f docker-compose.redis-cluster.yml up -d
#
# This creates a 6-node Redis Cluster (3 masters + 3 replicas)
# accessible on localhost ports 7000-7005.
#
# Test with: redis-cli -c -p 7000 CLUSTER INFO

services:
  redis-node-0:
    image: redis:7-alpine
    container_name: redis-cluster-0
    ports:
      - "127.0.0.1:7000:7000"
      - "127.0.0.1:17000:17000"
    volumes:
      - redis-cluster-0:/data
    command: >
      redis-server
      --port 7000
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --bind 0.0.0.0
      --protected-mode no
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7000", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-1:
    image: redis:7-alpine
    container_name: redis-cluster-1
    ports:
      - "127.0.0.1:7001:7001"
      - "127.0.0.1:17001:17001"
    volumes:
      - redis-cluster-1:/data
    command: >
      redis-server
      --port 7001
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --bind 0.0.0.0
      --protected-mode no
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7001", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-2:
    image: redis:7-alpine
    container_name: redis-cluster-2
    ports:
      - "127.0.0.1:7002:7002"
      - "127.0.0.1:17002:17002"
    volumes:
      - redis-cluster-2:/data
    command: >
      redis-server
      --port 7002
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --bind 0.0.0.0
      --protected-mode no
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7002", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-3:
    image: redis:7-alpine
    container_name: redis-cluster-3
    ports:
      - "127.0.0.1:7003:7003"
      - "127.0.0.1:17003:17003"
    volumes:
      - redis-cluster-3:/data
    command: >
      redis-server
      --port 7003
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --bind 0.0.0.0
      --protected-mode no
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7003", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-4:
    image: redis:7-alpine
    container_name: redis-cluster-4
    ports:
      - "127.0.0.1:7004:7004"
      - "127.0.0.1:17004:17004"
    volumes:
      - redis-cluster-4:/data
    command: >
      redis-server
      --port 7004
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --bind 0.0.0.0
      --protected-mode no
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7004", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-node-5:
    image: redis:7-alpine
    container_name: redis-cluster-5
    ports:
      - "127.0.0.1:7005:7005"
      - "127.0.0.1:17005:17005"
    volumes:
      - redis-cluster-5:/data
    command: >
      redis-server
      --port 7005
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --bind 0.0.0.0
      --protected-mode no
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "7005", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Initializer: creates cluster from the 6 nodes
  redis-cluster-init:
    image: redis:7-alpine
    container_name: redis-cluster-init
    depends_on:
      redis-node-0:
        condition: service_healthy
      redis-node-1:
        condition: service_healthy
      redis-node-2:
        condition: service_healthy
      redis-node-3:
        condition: service_healthy
      redis-node-4:
        condition: service_healthy
      redis-node-5:
        condition: service_healthy
    restart: "no"
    entrypoint: >
      sh -c "
        echo 'Creating Redis Cluster...' &&
        redis-cli --cluster create redis-node-0:7000 redis-node-1:7001 redis-node-2:7002 redis-node-3:7003 redis-node-4:7004 redis-node-5:7005 --cluster-replicas 1 --cluster-yes &&
        echo 'Redis Cluster created successfully' &&
        redis-cli -h redis-node-0 -p 7000 CLUSTER INFO
      "

volumes:
  redis-cluster-0:
  redis-cluster-1:
  redis-cluster-2:
  redis-cluster-3:
  redis-cluster-4:
  redis-cluster-5:
